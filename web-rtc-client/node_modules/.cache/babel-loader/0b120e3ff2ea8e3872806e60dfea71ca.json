{"ast":null,"code":"import { EventEmitter } from \"./web-rtc/EventEmitter\";\nimport io from \"socket.io-client\";\nimport { socket } from \"../../socket/socket\";\nvar SOCKET_EVENTS;\n\n(function (SOCKET_EVENTS) {\n  SOCKET_EVENTS[\"CONNECT\"] = \"connect\";\n  SOCKET_EVENTS[\"DISCONNECT\"] = \"disconnect\";\n})(SOCKET_EVENTS || (SOCKET_EVENTS = {}));\n\nclass RTCCall extends EventEmitter {\n  constructor(id, webRTC, options) {\n    super();\n    this.id = id;\n    this.webRTC = webRTC;\n    this.options = options;\n    this.sendOffer();\n  }\n\n  async sendOffer() {\n    // const connection = new RTCPeerConnection(this.webRTC.rtcConfiguration);\n    console.log(\"making call\");\n\n    for (const track of this.options._stream.getTracks()) {\n      console.log(\"adding track: \", {\n        track\n      });\n      this.webRTC.peerConnection.addTrack(track, this.options._stream);\n    }\n\n    const offer = await this.webRTC.peerConnection.createOffer();\n    await this.webRTC.peerConnection.setLocalDescription(offer);\n    const from = this.webRTC.socket.id;\n    this.webRTC.socket.emit(\"video:offer\", {\n      offer,\n      from,\n      to: this.id\n    });\n\n    this.webRTC.peerConnection.ontrack = ({\n      streams\n    }) => {\n      console.log(\"streams: \", streams);\n      this.emit(\"stream\", {\n        stream: streams[0]\n      });\n    };\n  }\n\n}\n\nclass WebRTC extends EventEmitter {\n  constructor(config) {\n    super();\n    this.peerConnection = void 0;\n    this.socket = void 0;\n    this.rtcConfiguration = void 0;\n    const {\n      socket,\n      ...rtcConfiguration\n    } = config;\n    this.rtcConfiguration = rtcConfiguration;\n    this.peerConnection = new RTCPeerConnection(rtcConfiguration);\n    this.socket = io(socket.url, socket.options);\n    this.socket.on(SOCKET_EVENTS.CONNECT, s => {\n      this.emit(SOCKET_EVENTS.CONNECT, this.socket);\n    });\n    this.socket.on(SOCKET_EVENTS.DISCONNECT, () => {\n      this.emit(SOCKET_EVENTS.DISCONNECT, this.socket);\n    });\n    this.socket.on(\"video:answer\", async ({\n      answer,\n      to,\n      from\n    }) => {\n      console.log(\"got answer: \", {\n        answer,\n        to,\n        from\n      });\n      await this.peerConnection.setRemoteDescription(answer);\n    });\n    this.socket.on(\"video:offer\", async ({\n      offer,\n      from\n    }) => {\n      console.log(\"got offer\", offer);\n      await this.peerConnection.setRemoteDescription(offer);\n      const thisOn = this.on;\n      this.emit(\"call\", {\n        // TODO: \"on\"\n        on: thisOn,\n        answer: async stream => {\n          console.log(\"got call\");\n\n          for (const track of stream.getTracks()) {\n            console.log(\"adding tracks: \", {\n              track\n            });\n            this.peerConnection.addTrack(track, stream);\n          }\n\n          const answer = await this.peerConnection.createAnswer();\n          await this.peerConnection.setLocalDescription(answer);\n          console.log(\"sending answer: \", {\n            answer,\n            to: from,\n            from: this.socket.id\n          });\n          this.socket.emit(\"video:answer\", {\n            from: this.socket.id,\n            to: from,\n            answer\n          });\n        }\n      });\n    });\n    this.socket.on(\"onicecandidate\", ({\n      candidate\n    }) => {\n      console.log(\"got candidate: \", {\n        candidate\n      });\n      this.peerConnection.addIceCandidate(candidate);\n    });\n  }\n\n  disconnect() {\n    this.socket.disconnect();\n  }\n\n  call(id, stream, options = {}) {\n    options._stream = stream;\n\n    this.peerConnection.onicecandidate = ({\n      candidate\n    }) => {\n      if (candidate) {\n        console.log(\"sending candidate: \", {\n          candidate\n        });\n        socket.emit(\"onicecandidate\", {\n          candidate,\n          to: id,\n          from: this.socket.id\n        });\n      }\n    };\n\n    const call = new RTCCall(id, this, options);\n    return call;\n  }\n\n}\n\nexport { WebRTC };","map":{"version":3,"sources":["/Users/stanislavpanchenko/Documents/development/web-rtc/web-rtc-client/src/pages/chat/WebRTC.ts"],"names":["EventEmitter","io","socket","SOCKET_EVENTS","RTCCall","constructor","id","webRTC","options","sendOffer","console","log","track","_stream","getTracks","peerConnection","addTrack","offer","createOffer","setLocalDescription","from","emit","to","ontrack","streams","stream","WebRTC","config","rtcConfiguration","RTCPeerConnection","url","on","CONNECT","s","DISCONNECT","answer","setRemoteDescription","thisOn","createAnswer","candidate","addIceCandidate","disconnect","call","onicecandidate"],"mappings":"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","sourcesContent":["import { EventEmitter } from \"./web-rtc/EventEmitter\";\nimport io from \"socket.io-client\";\nimport { socket } from \"../../socket/socket\";\n\nenum SOCKET_EVENTS {\n  CONNECT = \"connect\",\n  DISCONNECT = \"disconnect\",\n}\ninterface RTCPeerConnectionConfig {\n  iceServers: { urls: string }[];\n}\n\ninterface WebRTCPeerConnectionConfig extends RTCPeerConnectionConfig {\n  socket: {\n    url: string;\n    options: {\n      path: string;\n    };\n  };\n}\n\nclass RTCCall extends EventEmitter {\n  constructor(\n    private id: string,\n    private webRTC: WebRTC,\n    private options: { _stream: MediaStream }\n  ) {\n    super();\n    this.sendOffer();\n  }\n\n  async sendOffer() {\n    // const connection = new RTCPeerConnection(this.webRTC.rtcConfiguration);\n\n    console.log(\"making call\");\n    for (const track of this.options._stream.getTracks()) {\n      console.log(\"adding track: \", { track });\n      this.webRTC.peerConnection.addTrack(track, this.options._stream);\n    }\n\n    const offer = await this.webRTC.peerConnection.createOffer();\n    await this.webRTC.peerConnection.setLocalDescription(offer);\n    const from = this.webRTC.socket.id;\n\n    this.webRTC.socket.emit(\"video:offer\", { offer, from, to: this.id });\n\n    this.webRTC.peerConnection.ontrack = ({ streams }: any) => {\n      console.log(\"streams: \", streams);\n      this.emit(\"stream\", { stream: streams[0] });\n    };\n  }\n}\n\nclass WebRTC extends EventEmitter {\n  peerConnection;\n  socket: SocketIOClient.Socket;\n  rtcConfiguration: RTCPeerConnectionConfig;\n\n  constructor(config: WebRTCPeerConnectionConfig) {\n    super();\n    const { socket, ...rtcConfiguration } = config;\n    this.rtcConfiguration = rtcConfiguration;\n\n    this.peerConnection = new RTCPeerConnection(rtcConfiguration);\n    this.socket = io(socket.url, socket.options);\n\n    this.socket.on(SOCKET_EVENTS.CONNECT, (s: any) => {\n      this.emit(SOCKET_EVENTS.CONNECT, this.socket);\n    });\n\n    this.socket.on(SOCKET_EVENTS.DISCONNECT, () => {\n      this.emit(SOCKET_EVENTS.DISCONNECT, this.socket);\n    });\n\n    this.socket.on(\"video:answer\", async ({ answer, to, from }: any) => {\n      console.log(\"got answer: \", { answer, to, from });\n      await this.peerConnection.setRemoteDescription(answer);\n    });\n\n    this.socket.on(\"video:offer\", async ({ offer, from }: any) => {\n      console.log(\"got offer\", offer);\n\n      await this.peerConnection.setRemoteDescription(offer);\n      const thisOn = this.on;\n      this.emit(\"call\", {\n        // TODO: \"on\"\n        on: thisOn,\n        answer: async (stream: any) => {\n          console.log(\"got call\");\n          for (const track of stream.getTracks()) {\n            console.log(\"adding tracks: \", { track });\n            this.peerConnection.addTrack(track, stream);\n          }\n          const answer = await this.peerConnection.createAnswer();\n          await this.peerConnection.setLocalDescription(answer);\n\n          console.log(\"sending answer: \", {\n            answer,\n            to: from,\n            from: this.socket.id,\n          });\n          this.socket.emit(\"video:answer\", {\n            from: this.socket.id,\n            to: from,\n            answer,\n          });\n        },\n      });\n    });\n\n    this.socket.on(\"onicecandidate\", ({ candidate }: any) => {\n      console.log(\"got candidate: \", { candidate });\n      this.peerConnection.addIceCandidate(candidate);\n    });\n  }\n\n  disconnect() {\n    this.socket.disconnect();\n  }\n\n  call(id: string, stream: MediaStream, options: any = {}) {\n    options._stream = stream;\n\n    this.peerConnection.onicecandidate = ({ candidate }: any) => {\n      if (candidate) {\n        console.log(\"sending candidate: \", { candidate });\n        socket.emit(\"onicecandidate\", {\n          candidate,\n          to: id,\n          from: this.socket.id,\n        });\n      }\n    };\n\n    const call = new RTCCall(id, this, options);\n    return call;\n  }\n}\n\nexport { WebRTC };\nexport type { RTCPeerConnectionConfig };\n"]},"metadata":{},"sourceType":"module"}