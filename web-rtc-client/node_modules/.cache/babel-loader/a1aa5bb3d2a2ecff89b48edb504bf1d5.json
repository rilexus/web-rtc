{"ast":null,"code":"import { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nvar _jsxFileName = \"/Users/stanislavpanchenko/Documents/development/web-rtc/web-rtc-client/src/pages/web-rtc-chat/WebRTCChat.tsx\",\n    _s = $RefreshSig$();\n\nimport React, { useEffect, useLayoutEffect, useRef } from \"react\";\nimport { socketConnector } from \"../../socket/react-socket-connector/react-socket-connector\";\nimport { UserList } from \"../chat/components/user-list/UserList\";\nimport { LogoutButton } from \"../chat/components/logout-button/logout-button\";\nimport { SOCKET_ADDRESS, SOCKET_PREFIX } from \"../../evn\";\nimport { WebRTC } from \"../chat/WebRTC\";\nimport { useAuthentication } from \"../../authentication/hooks/useAuthentication\";\n\nconst openMediaDevices = async constraints => {\n  return await navigator.mediaDevices.getUserMedia(constraints);\n};\n\nconst connectVideo = (videoRef, stream) => {\n  videoRef.current.srcObject = stream;\n};\n\nconst _WebRTCChat = ({\n  emitVideoOffer\n}) => {\n  _s();\n\n  const webRTC = useRef(new WebRTC({\n    iceServers: [{\n      urls: \"stun:stun.1.google.com:19302\"\n    }],\n    socket: {\n      url: SOCKET_ADDRESS,\n      options: {\n        path: `/${SOCKET_PREFIX}`\n      }\n    }\n  }));\n  const [{\n    username: currentUserName\n  }] = useAuthentication();\n  const ownStream = useRef();\n  const ownVideoRef = useRef();\n  const foreignVideoRef = useRef();\n  const stream = useRef();\n  useEffect(() => {\n    webRTC.current.on(\"connect\", socket => {\n      socket.emit(\"associate\", {\n        socketId: socket.id,\n        username: currentUserName\n      });\n    });\n    return () => {\n      webRTC.current.disconnect();\n    };\n  }, []);\n  useLayoutEffect(() => {\n    webRTC.current.on(\"call\", async call => {\n      stream.current = await openMediaDevices({\n        video: true,\n        audio: true\n      });\n      ownVideoRef.current.srcObject = stream.current;\n      call.answer(stream.current);\n      call.on(\"stream\", function ({\n        stream\n      }) {\n        foreignVideoRef.current.srcObject = stream;\n      });\n    });\n  }, []);\n\n  const onVideo = async ({\n    name,\n    socketId\n  }) => {\n    stream.current = await openMediaDevices({\n      video: true,\n      audio: true\n    });\n    const call = webRTC.current.call(socketId, stream.current);\n    ownVideoRef.current.srcObject = stream.current;\n    call.on(\"stream\", ({\n      stream\n    }) => {\n      console.log(\"got stream: \", stream);\n      foreignVideoRef.current.srcObject = stream;\n    });\n  };\n\n  const onAudio = ({\n    name,\n    socketId\n  }) => {};\n\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    children: [/*#__PURE__*/_jsxDEV(UserList, {\n      onAudio: onAudio,\n      onVideo: onVideo\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 83,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(LogoutButton, {}, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 84,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          children: \"local\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 87,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          children: /*#__PURE__*/_jsxDEV(\"video\", {\n            id: \"ownVideo\",\n            ref: ownVideoRef,\n            autoPlay: true,\n            playsInline: true,\n            controls: false,\n            style: {\n              height: \"300px\",\n              width: \"300px\"\n            }\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 89,\n            columnNumber: 13\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 88,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 86,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          children: \"remote\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 103,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          children: /*#__PURE__*/_jsxDEV(\"video\", {\n            id: \"foreignVideo\",\n            ref: foreignVideoRef,\n            autoPlay: true,\n            playsInline: true,\n            controls: false,\n            style: {\n              height: \"300px\",\n              width: \"300px\"\n            }\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 105,\n            columnNumber: 13\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 104,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 102,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 85,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 82,\n    columnNumber: 5\n  }, this);\n};\n\n_s(_WebRTCChat, \"bNpfsjQ2+YtLt7qcmm3RmxYZX1Y=\", false, function () {\n  return [useAuthentication];\n});\n\nconst WebRTCChat = socketConnector(dispatch => {\n  return {\n    emitVideoOffer: (offer, from, to) => dispatch({\n      type: \"video:offer\",\n      offer,\n      from,\n      to\n    })\n  };\n})(_WebRTCChat);\nexport { WebRTCChat };","map":{"version":3,"sources":["/Users/stanislavpanchenko/Documents/development/web-rtc/web-rtc-client/src/pages/web-rtc-chat/WebRTCChat.tsx"],"names":["React","useEffect","useLayoutEffect","useRef","socketConnector","UserList","LogoutButton","SOCKET_ADDRESS","SOCKET_PREFIX","WebRTC","useAuthentication","openMediaDevices","constraints","navigator","mediaDevices","getUserMedia","connectVideo","videoRef","stream","current","srcObject","_WebRTCChat","emitVideoOffer","webRTC","iceServers","urls","socket","url","options","path","username","currentUserName","ownStream","ownVideoRef","foreignVideoRef","on","emit","socketId","id","disconnect","call","video","audio","answer","onVideo","name","console","log","onAudio","height","width","WebRTCChat","dispatch","offer","from","to","type"],"mappings":"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","sourcesContent":["import React, { useEffect, useLayoutEffect, useRef, useState } from \"react\";\nimport { socketConnector } from \"../../socket/react-socket-connector/react-socket-connector\";\nimport { UserList } from \"../chat/components/user-list/UserList\";\nimport { LogoutButton } from \"../chat/components/logout-button/logout-button\";\nimport { SOCKET_ADDRESS, SOCKET_PREFIX } from \"../../evn\";\nimport { WebRTC } from \"../chat/WebRTC\";\nimport { useAuthentication } from \"../../authentication/hooks/useAuthentication\";\nimport SocketIO from \"socket.io\";\n\nconst openMediaDevices = async (constraints: any) => {\n  return await navigator.mediaDevices.getUserMedia(constraints);\n};\n\nconst connectVideo = (videoRef: any, stream: any) => {\n  videoRef.current.srcObject = stream;\n};\n\nconst _WebRTCChat = ({ emitVideoOffer }: any) => {\n  const webRTC = useRef(\n    new WebRTC({\n      iceServers: [{ urls: \"stun:stun.1.google.com:19302\" }],\n      socket: {\n        url: SOCKET_ADDRESS,\n        options: {\n          path: `/${SOCKET_PREFIX}`,\n        },\n      },\n    })\n  );\n  const [{ username: currentUserName }] = useAuthentication();\n  const ownStream = useRef<any>();\n  const ownVideoRef = useRef<any>();\n  const foreignVideoRef = useRef<any>();\n  const stream = useRef<any>();\n\n  useEffect(() => {\n    webRTC.current.on(\"connect\", (socket: SocketIO.Socket) => {\n      socket.emit(\"associate\", {\n        socketId: socket.id,\n        username: currentUserName,\n      });\n    });\n    return () => {\n      webRTC.current.disconnect();\n    };\n  }, []);\n\n  useLayoutEffect(() => {\n    webRTC.current.on(\"call\", async (call) => {\n      stream.current = await openMediaDevices({\n        video: true,\n        audio: true,\n      });\n\n      ownVideoRef.current.srcObject = stream.current;\n      call.answer(stream.current);\n\n      call.on(\"stream\", function ({ stream }: any) {\n        foreignVideoRef.current.srcObject = stream;\n      });\n    });\n  }, []);\n\n  const onVideo = async ({ name, socketId }: any) => {\n    stream.current = await openMediaDevices({\n      video: true,\n      audio: true,\n    });\n    const call = webRTC.current.call(socketId, stream.current);\n\n    ownVideoRef.current.srcObject = stream.current;\n\n    call.on(\"stream\", ({ stream }) => {\n      console.log(\"got stream: \", stream);\n      foreignVideoRef.current.srcObject = stream;\n    });\n  };\n\n  const onAudio = ({ name, socketId }: any) => {};\n\n  return (\n    <div>\n      <UserList onAudio={onAudio} onVideo={onVideo} />\n      <LogoutButton />\n      <div>\n        <div>\n          <div>local</div>\n          <div>\n            <video\n              id={\"ownVideo\"}\n              ref={ownVideoRef}\n              autoPlay\n              playsInline\n              controls={false}\n              style={{\n                height: \"300px\",\n                width: \"300px\",\n              }}\n            />\n          </div>\n        </div>\n        <div>\n          <div>remote</div>\n          <div>\n            <video\n              id={\"foreignVideo\"}\n              ref={foreignVideoRef}\n              autoPlay\n              playsInline\n              controls={false}\n              style={{\n                height: \"300px\",\n                width: \"300px\",\n              }}\n            />\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\nconst WebRTCChat = socketConnector((dispatch) => {\n  return {\n    emitVideoOffer: (offer: any, from: string, to: string) =>\n      dispatch({ type: \"video:offer\", offer, from, to }),\n  };\n})(_WebRTCChat);\nexport { WebRTCChat };\n"]},"metadata":{},"sourceType":"module"}