{"ast":null,"code":"import { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nvar _jsxFileName = \"/Users/stanislavpanchenko/Documents/development/web-rtc/web-rtc-client/src/pages/chat/Chat.page.tsx\",\n    _s = $RefreshSig$();\n\nimport React, { useLayoutEffect, useRef, useState } from \"react\";\nimport { LogoutButton } from \"./components/logout-button/logout-button\";\nimport { UserList } from \"./components/user-list/UserList\";\nimport { useSubscription } from \"../../socket/use-subscription/useSubscription\";\nimport { socket } from \"../../socket/socket\";\nimport { useAuthentication } from \"../../context/authentication/Authentication.context\";\n\nconst openMediaDevices = async constraints => {\n  return await navigator.mediaDevices.getUserMedia(constraints);\n};\n\nconst constraints = {\n  video: true,\n  audio: false\n};\nlet stream = null;\nconst remoteStream = new MediaStream();\nconst configuration = {\n  iceServers: [{\n    urls: \"stun:10.68.87.6:3478\",\n    username: \"username\",\n    credential: \"password\"\n  }]\n};\nconst peerConnection = new RTCPeerConnection(configuration);\n\nconst ChatPage = () => {\n  _s();\n\n  const [hasOffer, setHasOffer] = useState(false);\n  const ownVideoRef = useRef();\n  const foreignVideoRef = useRef();\n  const offerRef = useRef({\n    from: null,\n    offer: null\n  });\n  const [isCalling, setIsCalling] = useState(false);\n  const [{\n    name: currentUserName\n  }] = useAuthentication();\n  useSubscription(\"video:answer\", async ({\n    answer,\n    from\n  }) => {\n    const remoteDesc = new RTCSessionDescription(answer);\n    await peerConnection.setRemoteDescription(remoteDesc);\n    setIsCalling(false);\n    stream.getTracks().forEach(track => {\n      peerConnection.addTrack(track, stream);\n    });\n    console.log(answer, from);\n  });\n  useSubscription(\"video:offer\", async ({\n    offer,\n    from\n  }) => {\n    setHasOffer(true);\n    offerRef.current = {\n      offer,\n      from\n    };\n    console.log(offer, from);\n  });\n\n  const pickUp = async () => {\n    if (offerRef.current.offer) {\n      // create answer\n      const {\n        from,\n        offer\n      } = offerRef.current;\n      await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));\n      const answer = await peerConnection.createAnswer();\n      await peerConnection.setLocalDescription(answer);\n      setIsCalling(false);\n      socket.emit(\"video:answer\", {\n        answer,\n        to: from,\n        from: currentUserName\n      });\n    }\n  };\n\n  const hangUp = () => {\n    if (offerRef.current) {// implement call decline\n    }\n  };\n\n  const onVideo = async name => {\n    const offer = await peerConnection.createOffer();\n    await peerConnection.setLocalDescription(offer);\n    setIsCalling(true);\n    peerConnection.addEventListener(\"track\", async event => {\n      // @ts-ignore\n      remoteStream.addTrack(event.track, remoteStream);\n    });\n    socket.emit(\"video:offer\", {\n      offer,\n      to: name,\n      from: currentUserName\n    });\n  };\n\n  const onAudio = name => {};\n\n  useLayoutEffect(() => {\n    const connect = async () => {\n      try {\n        stream = await openMediaDevices(constraints);\n        ownVideoRef.current.srcObject = stream;\n        foreignVideoRef.current.srcObject = remoteStream;\n      } catch (e) {\n        console.error(e);\n      }\n    };\n\n    connect();\n  }, []);\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    children: [/*#__PURE__*/_jsxDEV(UserList, {\n      onAudio: onAudio,\n      onVideo: onVideo\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 103,\n      columnNumber: 7\n    }, this), hasOffer && /*#__PURE__*/_jsxDEV(\"div\", {\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        children: \"CALLING....\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 106,\n        columnNumber: 11\n      }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n        onClick: pickUp,\n        children: \"PICK UP\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 107,\n        columnNumber: 11\n      }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n        children: \"HANG UP\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 108,\n        columnNumber: 11\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 105,\n      columnNumber: 9\n    }, this), isCalling && /*#__PURE__*/_jsxDEV(\"div\", {\n      children: /*#__PURE__*/_jsxDEV(\"div\", {\n        children: \"CALLING...!\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 113,\n        columnNumber: 11\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 112,\n      columnNumber: 9\n    }, this), /*#__PURE__*/_jsxDEV(LogoutButton, {}, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 116,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"video\", {\n      id: \"ownVideo\",\n      ref: ownVideoRef,\n      autoPlay: true,\n      playsInline: true,\n      controls: false,\n      style: {\n        height: \"300px\",\n        width: \"300px\"\n      }\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 118,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"video\", {\n      id: \"foreignVideo\",\n      ref: foreignVideoRef,\n      autoPlay: true,\n      playsInline: true,\n      controls: false,\n      style: {\n        height: \"300px\",\n        width: \"300px\"\n      }\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 129,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 102,\n    columnNumber: 5\n  }, this);\n};\n\n_s(ChatPage, \"pqGQSzc4ZjTuHVoztGwmzVRXFz4=\", false, function () {\n  return [useAuthentication, useSubscription, useSubscription];\n});\n\n_c = ChatPage;\nexport { ChatPage };\n\nvar _c;\n\n$RefreshReg$(_c, \"ChatPage\");","map":{"version":3,"sources":["/Users/stanislavpanchenko/Documents/development/web-rtc/web-rtc-client/src/pages/chat/Chat.page.tsx"],"names":["React","useLayoutEffect","useRef","useState","LogoutButton","UserList","useSubscription","socket","useAuthentication","openMediaDevices","constraints","navigator","mediaDevices","getUserMedia","video","audio","stream","remoteStream","MediaStream","configuration","iceServers","urls","username","credential","peerConnection","RTCPeerConnection","ChatPage","hasOffer","setHasOffer","ownVideoRef","foreignVideoRef","offerRef","from","offer","isCalling","setIsCalling","name","currentUserName","answer","remoteDesc","RTCSessionDescription","setRemoteDescription","getTracks","forEach","track","addTrack","console","log","current","pickUp","createAnswer","setLocalDescription","emit","to","hangUp","onVideo","createOffer","addEventListener","event","onAudio","connect","srcObject","e","error","height","width"],"mappings":"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","sourcesContent":["import React, { useLayoutEffect, useRef, useState } from \"react\";\nimport { LogoutButton } from \"./components/logout-button/logout-button\";\nimport { UserList } from \"./components/user-list/UserList\";\nimport { useSubscription } from \"../../socket/use-subscription/useSubscription\";\nimport { socket } from \"../../socket/socket\";\nimport { useAuthentication } from \"../../context/authentication/Authentication.context\";\n\nconst openMediaDevices = async (constraints: any) => {\n  return await navigator.mediaDevices.getUserMedia(constraints);\n};\n\nconst constraints = { video: true, audio: false };\nlet stream: any = null;\n\nconst remoteStream = new MediaStream();\n\nconst configuration = {\n  iceServers: [\n    {\n      urls: \"stun:10.68.87.6:3478\",\n      username: \"username\",\n      credential: \"password\",\n    },\n  ],\n};\nconst peerConnection = new RTCPeerConnection(configuration);\n\nconst ChatPage = () => {\n  const [hasOffer, setHasOffer] = useState(false);\n  const ownVideoRef = useRef<any>();\n  const foreignVideoRef = useRef<any>();\n  const offerRef = useRef<{ from: string | null; offer: any }>({\n    from: null,\n    offer: null,\n  });\n  const [isCalling, setIsCalling] = useState(false);\n  const [{ name: currentUserName }] = useAuthentication();\n\n  useSubscription(\"video:answer\", async ({ answer, from }) => {\n    const remoteDesc = new RTCSessionDescription(answer);\n    await peerConnection.setRemoteDescription(remoteDesc);\n    setIsCalling(false);\n    stream.getTracks().forEach((track: any) => {\n      peerConnection.addTrack(track, stream);\n    });\n    console.log(answer, from);\n  });\n\n  useSubscription(\"video:offer\", async ({ offer, from }) => {\n    setHasOffer(true);\n    offerRef.current = { offer, from };\n    console.log(offer, from);\n  });\n\n  const pickUp = async () => {\n    if (offerRef.current.offer) {\n      // create answer\n      const { from, offer } = offerRef.current;\n      await peerConnection.setRemoteDescription(\n        new RTCSessionDescription(offer)\n      );\n      const answer = await peerConnection.createAnswer();\n      await peerConnection.setLocalDescription(answer);\n      setIsCalling(false);\n      socket.emit(\"video:answer\", { answer, to: from, from: currentUserName });\n    }\n  };\n\n  const hangUp = () => {\n    if (offerRef.current) {\n      // implement call decline\n    }\n  };\n\n  const onVideo = async (name: string) => {\n    const offer = await peerConnection.createOffer();\n    await peerConnection.setLocalDescription(offer);\n    setIsCalling(true);\n    peerConnection.addEventListener(\"track\", async (event) => {\n      // @ts-ignore\n      remoteStream.addTrack(event.track, remoteStream);\n    });\n    socket.emit(\"video:offer\", { offer, to: name, from: currentUserName });\n  };\n\n  const onAudio = (name: string) => {};\n\n  useLayoutEffect(() => {\n    const connect = async () => {\n      try {\n        stream = await openMediaDevices(constraints);\n        ownVideoRef.current.srcObject = stream;\n        foreignVideoRef.current.srcObject = remoteStream;\n      } catch (e) {\n        console.error(e);\n      }\n    };\n    connect();\n  }, []);\n\n  return (\n    <div>\n      <UserList onAudio={onAudio} onVideo={onVideo} />\n      {hasOffer && (\n        <div>\n          <div>CALLING....</div>\n          <button onClick={pickUp}>PICK UP</button>\n          <button>HANG UP</button>\n        </div>\n      )}\n      {isCalling && (\n        <div>\n          <div>CALLING...!</div>\n        </div>\n      )}\n      <LogoutButton />\n\n      <video\n        id={\"ownVideo\"}\n        ref={ownVideoRef}\n        autoPlay\n        playsInline\n        controls={false}\n        style={{\n          height: \"300px\",\n          width: \"300px\",\n        }}\n      />\n      <video\n        id={\"foreignVideo\"}\n        ref={foreignVideoRef}\n        autoPlay\n        playsInline\n        controls={false}\n        style={{\n          height: \"300px\",\n          width: \"300px\",\n        }}\n      />\n    </div>\n  );\n};\n\nexport { ChatPage };\n"]},"metadata":{},"sourceType":"module"}